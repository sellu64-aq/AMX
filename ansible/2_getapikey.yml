- name: Update Grafana Main Org Name and Generate Service Account Token
  hosts: grafana_servers
  gather_facts: no
  vars:
    grafana_admin_user: "admin"
    grafana_admin_password: "admin"
    new_org_name: "{{ new_org_name }}"
    service_account_name: " {{ APIservice_account_name }}"
    service_account_role: "Admin"
    token_name: " {{APItoken_name }}"
    api_key_file: "{{ ansible_home }}/files/api_key.json"

  tasks:
    # 1. Update the main organization name
    - name: Update main organization name
      uri:
        url: "{{ grafana_url }}/api/org"
        method: PUT
        user: "{{ grafana_admin_user }}"
        password: "{{ grafana_admin_password }}"
        force_basic_auth: yes
        headers:
          Content-Type: "application/json"
        body: |
          {
            "name": "{{ new_org_name }}"
          }
        body_format: json
        status_code: 200
      register: update_org_response

    - name: Display the updated organization name
      debug:
        msg: "Main organization name updated to: {{ new_org_name }}"

    # 2. Search for the service account
    - name: Search for the service account
      uri:
        url: "{{ grafana_url }}/api/serviceaccounts/search?query={{ service_account_name }}"
        method: GET
        user: "{{ grafana_admin_user }}"
        password: "{{ grafana_admin_password }}"
        force_basic_auth: yes
        headers:
          Content-Type: "application/json"
        status_code: 200
      register: search_response

    - name: Check if the service account exists
      set_fact:
        existing_service_account: "{{ search_response.json.serviceAccounts[0] }}"
      when: search_response.json.serviceAccounts | length > 0

    - name: Display existing service account details
      debug:
        msg: "Existing Service Account: {{ existing_service_account }}"
      when: existing_service_account is defined

    # 3. Check for existing tokens
    - name: Get existing tokens for the service account
      uri:
        url: "{{ grafana_url }}/api/serviceaccounts/{{ existing_service_account.id }}/tokens"
        method: GET
        user: "{{ grafana_admin_user }}"
        password: "{{ grafana_admin_password }}"
        force_basic_auth: yes
        headers:
          Content-Type: "application/json"
        status_code: 200
      register: tokens_response
      when: existing_service_account is defined

    - name: Check if the token already exists
      set_fact:
        existing_token: "{{ tokens_response.json | selectattr('name', 'equalto', token_name) | list | first }}"
      when: tokens_response.json | length > 0

    - name: Display existing token details
      debug:
        msg: "Existing Token: {{ existing_token }}"
      when: existing_token is defined

    # 4. Delete the existing token (if needed)
    - name: Delete the existing token
      uri:
        url: "{{ grafana_url }}/api/serviceaccounts/{{ existing_service_account.id }}/tokens/{{ existing_token.id }}"
        method: DELETE
        user: "{{ grafana_admin_user }}"
        password: "{{ grafana_admin_password }}"
        force_basic_auth: yes
        headers:
          Content-Type: "application/json"
        status_code: 200
      when: existing_token is defined

    # 5. Generate a new token
    - name: Generate a new token for the service account
      uri:
        url: "{{ grafana_url }}/api/serviceaccounts/{{ existing_service_account.id }}/tokens"
        method: POST
        user: "{{ grafana_admin_user }}"
        password: "{{ grafana_admin_password }}"
        force_basic_auth: yes
        headers:
          Content-Type: "application/json"
        body: |
          {
            "name": "{{ token_name }}"
          }
        body_format: json
        status_code: 200
      register: new_token_response
      when: existing_service_account is defined

    - name: Debug the new token response
      debug:
        msg: "New Token Response: {{ new_token_response.json }}"

    # 6. Save the new API key to a file
    - name: Save the new API key to a file
      copy:
        content: |
          {
            "api_key": "{{ new_token_response.json.key | default('') }}"
          }
        dest: "{{ api_key_file }}"
        mode: '0600'
      when: new_token_response.json.key is defined
