---
- name: Deploy Telegraf monitoring to Kubernetes
  hosts: kubernetes
  gather_facts: no
  become: yes
  vars:
    deploy_telegraf_redis: false
    deploy_telegraf_infra: false
    deploy_telegraf_postgres: false

  pre_tasks:
    - name: Ensure Python Kubernetes library is installed
      pip:
        name: kubernetes
        state: present

  tasks:

    ####################################################
    # Redis Telegraf
    - name: Skip Redis Telegraf if not enabled
      debug:
        msg: "Redis Telegraf deployment disabled on this host, skipping."
      when: not deploy_telegraf_redis
      tags: skip_redis

    - name: Create Redis Telegraf ConfigMap
      k8s:
        state: present
        definition: "{{ lookup('template', '/opt/Airlinq/ansible/amx_ansible/playbooks/k8s/telegraf-redis-configmap.yaml.j2') }}"
      when: deploy_telegraf_redis
      tags: redis_monitoring

    - name: Deploy Redis Telegraf Deployment
      k8s:
        state: present
        definition: "{{ lookup('template', '/opt/Airlinq/ansible/amx_ansible/playbooks/k8s/telegraf-redis-deployment.yaml.j2') }}"
      when: deploy_telegraf_redis
      tags: redis_monitoring

    - name: Restart Telegraf Redis deployment
      shell: kubectl -n monitoring rollout restart deploy telegraf-redis
      register: redis_restart
      when: deploy_telegraf_redis
      ignore_errors: yes
      tags: redis_monitoring

    - name: Wait for Telegraf Redis rollout to complete
      shell: kubectl -n monitoring rollout status deploy telegraf-redis --timeout=180s
      register: redis_rollout_status
      when: deploy_telegraf_redis
      ignore_errors: yes
      tags: redis_monitoring

    - name: Display Redis Telegraf rollout result
      debug:
        msg: |
          Redis Telegraf rollout result:
          Command: {{ redis_rollout_status.cmd }}
          Stdout: {{ redis_rollout_status.stdout }}
          Stderr: {{ redis_rollout_status.stderr }}
      when: deploy_telegraf_redis
      tags: redis_monitoring

    - name: Check if Redis Telegraf rollout succeeded
      fail:
        msg: "❌ Redis Telegraf rollout failed! Error: {{ redis_rollout_status.stderr }}"
      when: deploy_telegraf_redis and (redis_rollout_status.rc != 0)
      tags: redis_monitoring

    - name: Confirm Redis Telegraf is up and running
      shell: kubectl -n monitoring get pods -l app=telegraf-redis --no-headers
      register: redis_pods
      when: deploy_telegraf_redis
      tags: redis_monitoring

    - name: Print Redis Telegraf pod status
      debug:
        msg: |
          ✅ Redis Telegraf Pods:
          {{ redis_pods.stdout }}
      when: deploy_telegraf_redis
      tags: redis_monitoring

    ####################################################
    # Infra Telegraf
    - name: Skip Infra Telegraf if not enabled
      debug:
        msg: "Infra Telegraf deployment disabled on this host, skipping."
      when: not deploy_telegraf_infra
      tags: skip_infra

    - name: Create Infra Telegraf ConfigMap
      k8s:
        state: present
        definition: "{{ lookup('template', '/opt/Airlinq/ansible/amx_ansible/playbooks/k8s/telegraf-infra-configmap.yaml.j2') }}"
      when: deploy_telegraf_infra
      tags: infra_monitoring

    - name: Deploy Infra Telegraf DaemonSet
      k8s:
        state: present
        definition: "{{ lookup('file', '/opt/Airlinq/ansible/amx_ansible/playbooks/k8s/telegraf-infra-daemonset.yaml') }}"
      when: deploy_telegraf_infra
      tags: infra_monitoring

    ####################################################
    # Postgres Telegraf
    - name: Skip Postgres Telegraf if not enabled
      debug:
        msg: "Postgres Telegraf deployment disabled on this host, skipping."
      when: not deploy_telegraf_postgres
      tags: skip_postgres

    - name: Create Postgres Telegraf ConfigMap
      k8s:
        state: present
        definition: "{{ lookup('template', '/opt/Airlinq/ansible/amx_ansible/playbooks/k8s/telegraf-postgres-configmap.yaml.j2') }}"
      when: deploy_telegraf_postgres
      tags: postgres_monitoring

    - name: Deploy Postgres Telegraf Deployment
      k8s:
        state: present
        definition: "{{ lookup('template', '/opt/Airlinq/ansible/amx_ansible/playbooks/k8s/telegraf-postgres-deployment.yaml.j2') }}"
      when: deploy_telegraf_postgres
      tags: postgres_monitoring

