---
- name: Deploy InfluxDB 2 under /opt/grafana/influxdb2
  hosts: all_servers
  become: true
  vars:
    base_dir: "/opt/grafana"
    influx2_dir: "{{ base_dir }}/influxdb2"
    influx2_bin_dir: "{{ influx2_dir }}/bin"
    influx2_data_dir: "{{ influx2_dir }}/data"
    influx2_log_dir: "{{ influx2_dir }}/logs"
    influx2_tar_src: "/home/aqadmin/Ansible/binaries/influxdb2-2.7.12_linux_amd64.tar.gz"
    influx2_tar_dest: "/tmp/influxdb2.tar.gz"
    influx2_service_name: "influxdb2"
    influx2_bind_port: "{{ influxdb2_port | default(8087) }}"

  tasks:
    - name: Ensure InfluxDB 2 directories exist
      file:
        path: "{{ item }}"
        state: directory
        owner: influxdb
        group: influxdb
        mode: '0755'
      loop:
        - "{{ influx2_dir }}"
        - "{{ influx2_bin_dir }}"
        - "{{ influx2_data_dir }}"
        - "{{ influx2_log_dir }}"

    - name: Check if influxd binary already exists
      stat:
        path: "{{ influx2_bin_dir }}/influxd"
      register: influx_bin_check
      changed_when: false

    - name: Copy InfluxDB 2 tarball if binary not already present
      copy:
        src: "{{ influx2_tar_src }}"
        dest: "{{ influx2_tar_dest }}"
        mode: '0644'
      when: not influx_bin_check.stat.exists

    - name: Extract InfluxDB 2 tarball if binary not already present
      unarchive:
        src: "{{ influx2_tar_dest }}"
        dest: "{{ influx2_bin_dir }}"
        remote_src: yes
        extra_opts: [ "--strip-components=3" ]
      when: not influx_bin_check.stat.exists
      notify: restart influxdb2

    - name: Create systemd service file for InfluxDB 2
      copy:
        dest: /etc/systemd/system/{{ influx2_service_name }}.service
        content: |
          [Unit]
          Description=InfluxDB 2 Service
          After=network.target

          [Service]
          User=influxdb
          Group=influxdb
          ExecStart={{ influx2_bin_dir }}/influxd \
            --bolt-path {{ influx2_data_dir }}/influxd.bolt \
            --engine-path {{ influx2_data_dir }}/engine \
            --http-bind-address :{{ influx2_bind_port }} \
            --log-level info
          WorkingDirectory={{ influx2_dir }}
          Restart=always

          [Install]
          WantedBy=multi-user.target
      notify: restart influxdb2

    - name: Reload systemd
      systemd:
        daemon_reload: yes

    - name: Enable and start InfluxDB 2
      systemd:
        name: "{{ influx2_service_name }}"
        state: started
        enabled: yes

    - name: Show InfluxDB 2 service status
      systemd:
        name: "{{ influx2_service_name }}"
        state: started
      register: influx2_status

    - name: Print InfluxDB 2 status
      debug:
        var: influx2_status

  handlers:
    - name: restart influxdb2
      systemd:
        name: "{{ influx2_service_name }}"
        state: restarted

