---
- hosts: grafana
  gather_facts: no
  become: yes
  vars:
    grafana_tar_src: "{{ ansible_folder }}/binaries/grafana-enterprise-12.0.2.linux-amd64.tar.gz"
    grafana_install_dir: "{{ telegraf_remote_path }}/grafana"
    grafana_user: {{ telegraf_user }}
    grafana_group: {{ telegraf_group }}
    grafana_version_dir: "{{ grafana_install_dir }}/grafana-enterprise-12.0.2"

  tasks:

    - name: Set effective group (fallback to 'grafana' if target_group is not passed)
      set_fact:
        effective_group: "{{ target_group | default('grafana') }}"
      tags: always

    - name: Load group-specific variables from group_vars
      include_vars:
        file: "../group_vars/{{ effective_group }}.yml"
      tags: always

    - name: Check if Grafana is already running
      systemd:
        name: grafana-server
      register: grafana_status
      failed_when: false

    - name: Skip Grafana install if already running
      debug:
        msg: "Grafana is already running, skipping installation tasks."
      when: grafana_status.status.ActiveState == "active"

    - block:
        - name: Ensure Grafana install directory exists
          file:
            path: "{{ grafana_install_dir }}"
            state: directory
            owner: "{{ grafana_user }}"
            group: "{{ grafana_group }}"
            mode: '0755'

        - name: Copy Grafana tarball to install dir
          copy:
            src: "{{ grafana_tar_src }}"
            dest: "{{ grafana_install_dir }}/"
            mode: '0644'

        - name: Remove existing symlink and version folder
          file:
            path: "{{ item }}"
            state: absent
          loop:
            - "{{ grafana_install_dir }}/current"
            - "{{ grafana_version_dir }}"

        - name: Extract Grafana tarball
          unarchive:
            src: "{{ grafana_install_dir }}/{{ grafana_tar_src | basename }}"
            dest: "{{ grafana_install_dir }}"
            remote_src: yes

        - name: Find extracted folder
          find:
            paths: "{{ grafana_install_dir }}"
            file_type: directory
            patterns: "grafana*"
          register: grafana_dirs

        - name: Set fact for extracted Grafana directory
          set_fact:
            grafana_extracted_dir: "{{ grafana_dirs.files[0].path }}"

        - name: Deploy custom Grafana config from template
          template:
            src: "{{ ansible_folder }}/playbooks/files/grafana.ini.j2"
            dest: "{{ grafana_install_dir }}/grafana.ini"
            owner: "{{ grafana_user }}"
            group: "{{ grafana_group }}"
            mode: '0644'

        - name: Create Grafana systemd service
          copy:
            dest: /etc/systemd/system/grafana-server.service
            content: |
              [Unit]
              Description=Grafana service
              After=network.target

              [Service]
              User=aqadmin
              Group=aqadmin
              Type=simple
              WorkingDirectory={{ grafana_install_dir }}/current
              ExecStart={{ grafana_install_dir }}/current/bin/grafana-server \
                --homepath={{ grafana_install_dir }}/current \
                --config={{ grafana_install_dir }}/grafana.ini
              Restart=on-failure
              LimitNOFILE=10000

              [Install]
              WantedBy=multi-user.target

        - name: Create symlink to current
          file:
            src: "{{ grafana_extracted_dir }}"
            dest: "{{ grafana_install_dir }}/current"
            state: link

        - name: Fix ownership of install dir
          file:
            path: "{{ grafana_install_dir }}"
            owner: "{{ grafana_user }}"
            group: "{{ grafana_group }}"
            recurse: yes

        - name: Reload systemd
          command: systemctl daemon-reload

        - name: Start and enable Grafana
          systemd:
            name: grafana-server
            state: restarted
            enabled: yes

        - name: Remove tarball after extraction
          file:
            path: "{{ grafana_install_dir }}/{{ grafana_tar_src | basename }}"
            state: absent

      when: grafana_status.status.ActiveState != "active"

    - name: Wait for Grafana API to come up
      uri:
        url: "{{ grafana_api_url }}/api/health"
        status_code: 200
      register: result
      until: result.status == 200
      retries: 15
      delay: 5

    # ---------------------------------------------------
    # Add Datasources if not exist
    # ---------------------------------------------------
    - name: Check if InfluxDB primary datasource exists
      uri:
        url: "{{ grafana_api_url }}/api/datasources/name/{{ influx_priDS_name }}"
        method: GET
        user: "{{ grafana_user_name }}"
        password: "{{ grafana_password }}"
        force_basic_auth: yes
        status_code: 200,404
      register: datasource_check_primary

    - name: Add primary InfluxDB datasource if not exists
      uri:
        url: "{{ grafana_api_url }}/api/datasources"
        method: POST
        user: "{{ grafana_user_name }}"
        password: "{{ grafana_password }}"
        force_basic_auth: yes
        status_code: 200,409
        headers:
          Content-Type: "application/json"
        body_format: json
        body: |
          {
            "name": "{{ influx_priDS_name }}",
            "type": "influxdb",
            "access": "proxy",
            "url": "http://{{ influx_Pri_IP }}:{{ influx_Pri_Port }}",
            "database": "{{ influx_priDB_name }}",
            "isDefault": true,
            "jsonData": {
              "httpMode": "GET"
            }
          }
      register: add_datasource_primary
      when: datasource_check_primary.status == 404

    - name: Show primary datasource response
      debug:
        var: add_datasource_primary
      when: datasource_check_primary.status == 404

    - name: Check if InfluxDB secondary datasource exists
      uri:
        url: "{{ grafana_api_url }}/api/datasources/name/{{ influx_secDS_name }}"
        method: GET
        user: "{{ grafana_user_name }}"
        password: "{{ grafana_password }}"
        force_basic_auth: yes
        status_code: 200,404
      register: datasource_check_secondary

    - name: Add secondary InfluxDB datasource if not exists
      uri:
        url: "{{ grafana_api_url }}/api/datasources"
        method: POST
        user: "{{ grafana_user_name }}"
        password: "{{ grafana_password }}"
        force_basic_auth: yes
        status_code: 200,409
        headers:
          Content-Type: "application/json"
        body_format: json
        body: |
          {
            "name": "{{ influx_secDS_name }}",
            "type": "influxdb",
            "access": "proxy",
            "url": "http://{{ influx_Sec_IP }}:{{ influx_Sec_Port }}",
            "database": "{{ influx_secDB_name }}",
            "isDefault": false,
            "jsonData": {
              "httpMode": "GET"
            }
          }
      register: add_datasource_secondary
      when: datasource_check_secondary.status == 404

    - name: Show secondary datasource response
      debug:
        var: add_datasource_secondary
      when: datasource_check_secondary.status == 404

    # -----------------------------------------
    # NEW: Get Existing Folders
    # -----------------------------------------
    - name: Get all existing Grafana folders
      uri:
        url: "{{ grafana_api_url }}/api/folders"
        method: GET
        user: "{{ grafana_user_name }}"
        password: "{{ grafana_password }}"
        force_basic_auth: yes
        return_content: yes
        status_code: 200
      register: existing_folders_response

    - name: Extract existing folder titles
      set_fact:
        existing_folders: "{{ existing_folders_response.json | map(attribute='title') | list }}"

    # -----------------------------------------
    # NEW: Create Folders in Grafana (if not exists)
    # -----------------------------------------
    - name: Create dashboard folders in Grafana
      uri:
        url: "{{ grafana_api_url }}/api/folders"
        method: POST
        user: "{{ grafana_user_name }}"
        password: "{{ grafana_password }}"
        force_basic_auth: yes
        headers:
          Content-Type: "application/json"
        body_format: json
        body: "{{ {'title': item} }}"
      loop:
        - App
        - Infra
        - Databases
        - API
        - BusinessKPIs
        - Alerts
      when: item not in existing_folders
      register: create_folders

    - name: Show folder creation result
      debug:
        var: create_folders


    # -----------------------------------------
    # NEW: Create Email Contact Point
    # -----------------------------------------
    - name: Create email contact point in Grafana
      uri:
        url: "{{ grafana_api_url }}/api/v1/provisioning/contact-points"
        method: POST
        user: "{{ grafana_user_name }}"
        password: "{{ grafana_password }}"
        force_basic_auth: yes
        headers:
          Content-Type: "application/json"
        status_code: 202,409  # ðŸ‘ˆ accept 202 as success
        body_format: json
        body: |
          {
            "name": "Email-AQNOC",
            "type": "email",
            "settings": {
              "addresses": "aqnoc@airlinq.com"
            },
            "isDefault": false
          }
      register: create_contact_point

    - name: Show contact point creation result
      debug:
        var: create_contact_point
