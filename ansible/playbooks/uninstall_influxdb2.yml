---
- name: Uninstall InfluxDB 2 from /opt/grafana/influxdb2
  hosts: all_servers
  become: true
  vars:
    base_dir: "/opt/grafana"
    influx2_dir: "{{ base_dir }}/influxdb2"
    influx2_service_name: "influxdb2"

  tasks:
    - name: Stop InfluxDB 2 service if exists
      systemd:
        name: "{{ influx2_service_name }}"
        state: stopped
      ignore_errors: yes

    - name: Disable InfluxDB 2 service
      systemd:
        name: "{{ influx2_service_name }}"
        enabled: no
      ignore_errors: yes

    - name: Remove InfluxDB 2 systemd service file
      file:
        path: "/etc/systemd/system/{{ influx2_service_name }}.service"
        state: absent

    - name: Reload systemd to forget InfluxDB 2
      systemd:
        daemon_reload: yes

    - name: Remove InfluxDB 2 directory completely
      file:
        path: "{{ influx2_dir }}"
        state: absent

    - name: Show success message
      debug:
        msg: "InfluxDB 2 successfully uninstalled and cleaned from {{ influx2_dir }}"

