---
- hosts: grafana
  gather_facts: no
  vars:
    folder_name: "App"   # leave empty "" to import into General folder
    dashboard_file: "{{ ansible_folder }}/dashboards/{{ dashboard_name }}"
    dashboard_ext: "{{ dashboard_name.split('.')[-1] }}"

  tasks:
    - name: Debug to confirm dashboard file
      debug:
        msg: "Importing dashboard from {{ dashboard_file }}"

    - name: Get list of folders to find App folder
      uri:
        url: "{{ grafana_api_url }}/api/folders"
        method: GET
        headers:
          Authorization: "Bearer {{ grafana_api_key }}"
        return_content: yes
        status_code: 200
        validate_certs: no
        follow_redirects: all
      register: folder_list
      when: folder_name != ""

    - name: Find App folder case-insensitive by title
      set_fact:
        app_folder: >-
          {{
            folder_list.json
            | selectattr('title', 'search', '(?i)^' + folder_name + '$')
            | list
          }}
      when: folder_name != ""

    - name: Debug existing found folder
      debug:
        var: app_folder
      when: folder_name != ""

    - name: Set found folder UID if exists
      set_fact:
        folder_uid: "{{ app_folder[0].uid }}"
      when: folder_name != "" and (app_folder | length > 0)

    - name: Create folder if it does not exist
      uri:
        url: "{{ grafana_api_url }}/api/folders"
        method: POST
        headers:
          Authorization: "Bearer {{ grafana_api_key }}"
          Content-Type: "application/json"
        status_code: [200,202,409]
        body_format: json
        body:
          title: "{{ folder_name }}"
          validate_certs: no
          follow_redirects: all
      register: create_folder_response
      when: folder_name != "" and (app_folder | length == 0)

    - name: Set folder UID from created folder
      set_fact:
        folder_uid: "{{ create_folder_response.json.uid }}"
      when: folder_name != "" and (app_folder | length == 0)

    - name: Default folder UID to empty string for General folder
      set_fact:
        folder_uid: ""
      when: folder_name == ""

    - name: Debug final folder UID to confirm
      debug:
        msg: "Using folderUid={{ folder_uid }}"

    - name: Ensure dashboards directory exists on target
      file:
        path: "{{ telegraf_remote_path }}/dashboards/"
        state: directory
        owner: "{{ telegraf_user }}"
        group: "{{ telegraf_group }}"
        mode: '0755'

    - name: Render dashboard template if .j2 file
      template:
        src: "{{ dashboard_file }}"
        dest: "{{ telegraf_remote_path }}/dashboards/{{ dashboard_file | basename | regex_replace('.j2$', '') }}"
        mode: '0644'
      when: dashboard_file | regex_search('.j2$')

    - name: Copy dashboard JSON to remote if normal .json
      copy:
        src: "{{ dashboard_file }}"
        dest: "{{ telegraf_remote_path }}/dashboards/{{ dashboard_file | basename }}"
        mode: '0644'
      when: not (dashboard_file | regex_search('.j2$'))

    - name: Get list of datasources from Grafana
      uri:
        url: "{{ grafana_api_url }}/api/datasources"
        method: GET
        headers:
          Authorization: "Bearer {{ grafana_api_key }}"
        return_content: yes
        status_code: 200
        validate_certs: no
      register: grafana_datasources

    - name: Find matching InfluxDB datasource UID by name
      set_fact:
        influx_priDS_uid: >-
          {{
            (grafana_datasources.json
            | selectattr('name', 'equalto', influx_priDS_name)
            | map(attribute='uid')
            | first)
          }}

    - name: Debug datasource UID found
      debug:
        msg: "Datasource {{ influx_priDS_name }} UID: {{ influx_priDS_uid }}"


    - name: Load dashboard JSON from remote file
      slurp:
        src: "{{ telegraf_remote_path }}/dashboards/{{ dashboard_file | basename | regex_replace('.j2$', '') }}"
      register: dashboard_content

    - name: Inject folderUid & overwrite flag (keep ${influxdb} dynamic)
      set_fact:
        import_payload: >-
          {{
            (dashboard_content.content | b64decode | from_json)
            | combine({
                'dashboard': (
                  (dashboard_content.content | b64decode | from_json).dashboard
                  | combine({}, recursive=True)
                ),
                'folderUid': folder_uid,
                'overwrite': True
              }, recursive=True)
          }}

    - name: Show only changed portion before import
      debug:
        msg:
          - "folderUid: {{ import_payload.folderUid }}"
          - "overwrite: {{ import_payload.overwrite }}"

    - name: Show dashboard title from loaded JSON
      debug:
        msg: "Dashboard title is: {{ import_payload.dashboard.title }}"

    - name: Import dashboard into Grafana
      uri:
  #      url: "{{ grafana_api_url }}/api/dashboards/import"
        url: "{{ grafana_api_url }}/api/dashboards/db"
        method: POST
        headers:
          Authorization: "Bearer {{ grafana_api_key }}"
          Content-Type: "application/json"
        body: "{{ import_payload }}"
        body_format: json
        status_code: [200,202,409]
        validate_certs: no        # Since using IP with self-signed cert
        follow_redirects: all     # Allow following the redirect
      register: grafana_import_response

    - name: Show response from Grafana
      debug:
        var: grafana_import_response.json
