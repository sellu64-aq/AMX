---
- name: Provision Grafana alert rule
  hosts: grafana
  gather_facts: no
  vars:
    folder_name: "Alerts"
    folder_uid_default: "alerts-folder"
    full_alert_path: "{{ ansible_folder }}/grafana_alerts/{{ alert_file | dirname }}"
    alert_template_path: "{{ full_alert_path }}/{{ alert_file | basename }}"
    rendered_alert_path: "/tmp/rendered_alerts"

  tasks:
    - name: Ensure rendered alert path exists
      file:
        path: "{{ rendered_alert_path }}"
        state: directory
        mode: '0755'

    - name: Get folder UID from Grafana
      uri:
        url: "{{ grafana_api_url }}/api/folders"
        method: GET
        headers:
          Authorization: "Bearer {{ grafana_api_key }}"
          Content-Type: "application/json"
        return_content: true
      register: grafana_folders

    - name: Set folder UID from response
      set_fact:
        alerts_folder_uid: "{{ item.uid }}"
      loop: "{{ grafana_folders.json }}"
      when: item.title == folder_name

    - name: Get datasource UID from Grafana
      uri:
        url: "{{ grafana_api_url }}/api/datasources"
        method: GET
        headers:
          Authorization: "Bearer {{ grafana_api_key }}"
          Content-Type: "application/json"
        return_content: true
      register: grafana_datasources

    - name: Set datasource UID
      set_fact:
        datasourceUid: "{{ item.uid }}"
      loop: "{{ grafana_datasources.json }}"
      when: item.name == influx_priDS_name

    - name: Fetch existing alert rules
      uri:
        url: "{{ grafana_api_url }}/api/v1/provisioning/alert-rules"
        method: GET
        headers:
          Authorization: "Bearer {{ grafana_api_key }}"
          Content-Type: "application/json"
        return_content: true
      register: existing_alerts

    - name: Set existing alert UID if it already exists (based on title + folder)
      set_fact:
        alert_uid: "{{ item.uid }}"
      loop: "{{ existing_alerts.json }}"
      when:
        - item.title == (alert_file | basename | regex_replace('.json.j2$', '') | regex_replace('_', ' '))
        - item.folderUID == alerts_folder_uid
      loop_control:
        label: "{{ item.title }}"

    - name: Generate a new unique UID if no existing UID found
      set_fact:
        alert_uid: "{{ lookup('password', '/dev/null length=12 chars=ascii_letters') }}"
      when: alert_uid is not defined

    - name: Render alert file from template
      template:
        src: "{{ alert_template_path }}"   # <-- use full path
        dest: "{{ rendered_alert_path }}/{{ alert_file | basename | regex_replace('.j2$', '') }}"
      vars:
        folder_uid: "{{ alerts_folder_uid }}"
        org_id: "{{ grafana_org_id }}"
        alert_uid: "{{ alert_uid | default(datasourceUid) }}"
        datasourceUid: "{{ datasourceUid }}"
        rulegroup: "{{ rulegroup }}"

    - name: Slurp rendered alert JSON from remote file
      slurp:
        src: "{{ rendered_alert_path }}/{{ alert_file | basename | regex_replace('.j2$', '') }}"
      register: alert_file_raw

    - name: Decode slurped JSON content
      set_fact:
        alert_payload: "{{ alert_file_raw.content | b64decode | from_json }}"

    - name: Inject correct UID into alert payload if existing UID is found
      set_fact:
        alert_payload: "{{ alert_payload | combine({'uid': alert_uid}) }}"
      when: alert_uid is defined

    - name: Create new alert in Grafana
      uri:
        url: "{{ grafana_api_url }}/api/v1/provisioning/alert-rules"
        method: POST
        headers:
          Authorization: "Bearer {{ grafana_api_key }}"
          Content-Type: "application/json"
        body: "{{ alert_payload }}"
        body_format: json
        status_code: [200, 201, 202, 409]
      register: upload_result

    - name: Show upload result
      debug:
        var: upload_result
