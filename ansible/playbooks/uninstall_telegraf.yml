---
- name: Uninstall Telegraf 1.34.2 single instance config
  hosts: "{{ target_group | default('all_servers') }}"
  become: yes
  gather_facts: yes

  vars:
    telegraf_remote_path: "{{ telegraf_base_path | default('/opt/airlinq/grafana') }}"
    telegraf_name: ""

  tasks:

    - name: Set effective group (fallback to 'infra' if target_group is not passed)
      set_fact:
        effective_group: "{{ target_group | default('all_servers') }}"
      tags: always

    - name: Load group-specific variables from group_vars
      include_vars:
        file: "../group_vars/{{ effective_group }}.yml"
      tags: always

    - name: Validate required vars
      assert:
        that:
          - telegraf_name != ""
        fail_msg: "You must pass -e telegraf_name=<name>"
      tags: validate

    - name: Stop and disable telegraf systemd service
      systemd:
        name: "telegraf-{{ telegraf_name }}"
        state: stopped
        enabled: no
      ignore_errors: yes
      tags: systemd

    - name: Remove telegraf systemd service file
      file:
        path: "/etc/systemd/system/telegraf-{{ telegraf_name }}.service"
        state: absent
      tags: systemd

    - name: Reload systemd to clear removed service
      systemd:
        daemon_reload: yes
      tags: systemd

    - name: Remove Telegraf config, binary, logs, and script files for the instance
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ telegraf_remote_path }}/telegraf/{{ telegraf_name }}_tele.conf"
        - "{{ telegraf_remote_path }}/telegraf/logs/telegraf_{{ telegraf_name }}.log"
        - "{{ telegraf_remote_path }}/scripts/{{ telegraf_name }}_app_metrics.sh"
        - "{{ telegraf_remote_path }}/telegraf/bin/telegraf"
      tags: cleanup

    - name: Optionally remove telegraf base path (only if empty)
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ telegraf_remote_path }}/telegraf/bin"
        - "{{ telegraf_remote_path }}/telegraf/logs"
        - "{{ telegraf_remote_path }}/telegraf"
        - "{{ telegraf_remote_path }}/scripts"
      tags: cleanup
      ignore_errors: yes

