#!/bin/bash
##############################################################################
# Monitor connection states (established, time_wait, etc.) for given IPs (local or remote)
# Jinja template: port_listen_monitor.sh for Telegraf
# Monitor listening ports on local IPs only
# Usage: via Telegraf
# Generated for Ansible for {{ inventory_hostname }}
# Developed by: K. Selvam Enoch (777)
##############################################################################
SS=/usr/sbin/ss
AWK=/usr/bin/awk

# Get local IPs from Ansible or fallback to hostname -I
LOCAL_IPS="{{ ansible_all_ipv4_addresses | join(' ') | default('', true) }}"
if [ -z "$LOCAL_IPS" ]; then
    LOCAL_IPS="$(hostname -I)"
fi

# Include loopback explicitly
LOCAL_IPS="$LOCAL_IPS 127.0.0.1 ::1"

# Capture listening sockets (TCP + SCTP)
ss_listen_tcp=$($SS -ltnH)
ss_listen_sctp=$($SS -lnH -A sctp)

{% for idx in range(ports | length) %}
PORT={{ ports[idx].port }}
NAME="{{ ports[idx].name | default('unknown') }}"
IP="{{ ports[idx].ip | default('*') }}"

# Determine if IP is local
IS_LOCAL=false
for local_ip in $LOCAL_IPS; do
    if [[ "$IP" == "$local_ip" ]]; then
        IS_LOCAL=true
        break
    fi
done

# Check common local bindings
if [[ "$IP" == "127.0.0.1" || "$IP" == "::1" || "$IP" == "0.0.0.0" || "$IP" == "*" || "$IP" == "::" || "$IP" == ":::" ]]; then
    IS_LOCAL=true
fi

if $IS_LOCAL; then

listen_tcp=$($AWK -v ip="$IP" -v port="$PORT" '
{
    local = $4
    gsub(/\[|\]/,"",local)
    gsub(/^::ffff:/,"",local)

if (local == ip":"port || local == "0.0.0.0:"port || local == ":::"port || local == "*:"port) found=1

    }
END { print (found ? 1 : 0) }
' <<< "$ss_listen_tcp")

listen_sctp=$($AWK -v ip="$IP" -v port="$PORT" '
{
    local = $4
    gsub(/\[|\]/,"",local)
    gsub(/^::ffff:/,"",local)
if (local == ip":"port || local == "0.0.0.0:"port || local == ":::"port || local == "*:"port) found=1
}
END { print (found ? 1 : 0) }
' <<< "$ss_listen_sctp")

listen_state=$((listen_tcp + listen_sctp))

echo "port_monitor,project={{ project }},zone={{ zone }},host={{ inventory_hostname }},direction=local,name=$NAME,ip=$IP,port=$PORT listen_state=$listen_state"

fi

{% endfor %}

