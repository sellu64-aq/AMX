#!/bin/bash

##############################################################################
# Script: mysql_replication_to_influxdb.sh
# Description: Monitors MySQL replication status and pushes metrics to InfluxDB
# Usage: ./mysql_replication_to_influxdb.sh
# Generated by Ansible for {{ inventory_hostname }}
# Developer: .K.Selvam.Enoch.
##############################################################################

# InfluxDB Primary Configuration
INFLUXDB_PRI_HOST="{{ influx_Pri_IP }}"
INFLUXDB_PRI_PORT="{{ influx_Pri_Port }}"
INFLUXDB_PRI_DATABASE="{{ influx_priDB_name }}"

# InfluxDB Secondary Configuration
INFLUXDB_SEC_HOST="{{ influx_Sec_IP }}"
INFLUXDB_SEC_PORT="{{ influx_Sec_Port }}"
INFLUXDB_SEC_DATABASE="{{ influx_secDB_name }}"

# MySQL Configuration
{% if mysql_servers is defined and mysql_servers|length > 0 %}
MYSQL_USER="{{ mysql_servers[0].user }}"
MYSQL_PASSWORD="{{ mysql_servers[0].password }}"
MYSQL_HOST="{{ mysql_servers[0].host }}"
MYSQL_PORT="{{ mysql_servers[0].port | default('3306') }}"
{% else %}
MYSQL_USER="root"
MYSQL_PASSWORD="Root@123"
MYSQL_HOST="localhost"
MYSQL_PORT="3306"
{% endif %}

# Hostname for tagging
HOSTNAME="{{ inventory_hostname }}"

# Additional tags
PROJECT="{{ project | default('AMX') }}"
ZONE="{{ zone | default('Unknown') }}"
ENVIRONMENT="{{ env | default('production') }}"

# Temporary file for MySQL output
TEMP_FILE="/tmp/mysql_replica_status_$$.txt"

# Get current timestamp in nanoseconds
TIMESTAMP=$(date +%s%N)

# Function to push data to InfluxDB (supports both primary and secondary)
push_to_influxdb() {
    local measurement=$1
    local tags=$2
    local fields=$3
    local timestamp=$4

    # Build InfluxDB line protocol
    local line_protocol="${measurement},${tags} ${fields} ${timestamp}"

    # Push to Primary InfluxDB
    local pri_result=$(curl -s -o /dev/null -w "%{http_code}" -XPOST \
        "http://${INFLUXDB_PRI_HOST}:${INFLUXDB_PRI_PORT}/write?db=${INFLUXDB_PRI_DATABASE}" \
        --data-binary "${line_protocol}" 2>&1)

    if [ "$pri_result" = "204" ]; then
        echo "  ✓ Primary InfluxDB: Success (${INFLUXDB_PRI_HOST}:${INFLUXDB_PRI_PORT}/${INFLUXDB_PRI_DATABASE})"
    else
        echo "  ✗ Primary InfluxDB: Failed (HTTP $pri_result) (${INFLUXDB_PRI_HOST}:${INFLUXDB_PRI_PORT}/${INFLUXDB_PRI_DATABASE})"
    fi

    # Push to Secondary InfluxDB
    local sec_result=$(curl -s -o /dev/null -w "%{http_code}" -XPOST \
        "http://${INFLUXDB_SEC_HOST}:${INFLUXDB_SEC_PORT}/write?db=${INFLUXDB_SEC_DATABASE}" \
        --data-binary "${line_protocol}" 2>&1)

    if [ "$sec_result" = "204" ]; then
        echo "  ✓ Secondary InfluxDB: Success (${INFLUXDB_SEC_HOST}:${INFLUXDB_SEC_PORT}/${INFLUXDB_SEC_DATABASE})"
    else
        echo "  ✗ Secondary InfluxDB: Failed (HTTP $sec_result) (${INFLUXDB_SEC_HOST}:${INFLUXDB_SEC_PORT}/${INFLUXDB_SEC_DATABASE})"
    fi
}

# Function to send channel data to InfluxDB
send_channel_data() {
    local channel=$1
    local source_host=$2
    local source_port=$3
    local io_running=$4
    local sql_running=$5
    local seconds_behind=$6
    local last_io_errno=$7
    local last_sql_errno=$8
    local source_log_file=$9
    local read_pos=${10}
    local exec_pos=${11}
    local relay_space=${12}

    # Build tags with additional metadata
    local tags="host=${HOSTNAME},channel=${channel},source_host=${source_host},source_port=${source_port},project=${PROJECT},zone=${ZONE},environment=${ENVIRONMENT}"

    # Calculate replication lag in bytes
    local replication_lag=$((read_pos - exec_pos))

    # Overall health (1 if both IO and SQL running, 0 otherwise)
    local health=0
    if [ "$io_running" -eq 1 ] && [ "$sql_running" -eq 1 ]; then
        health=1
    fi

    # Build fields
    local fields="io_running=${io_running}i,sql_running=${sql_running}i,seconds_behind_source=${seconds_behind}i,last_io_errno=${last_io_errno}i,last_sql_errno=${last_sql_errno}i,read_source_log_pos=${read_pos}i,exec_source_log_pos=${exec_pos}i,relay_log_space=${relay_space}i,replication_lag_bytes=${replication_lag}i,replication_healthy=${health}i"

    # Push to both InfluxDB instances
    echo "Pushing metrics for channel: $channel (Source: $source_host:$source_port, Lag: ${seconds_behind}s, Health: $health)"
    push_to_influxdb "mysql_replica_status" "$tags" "$fields" "$TIMESTAMP"
}

# Main execution
echo "============================================================"
echo "Starting MySQL Replication Status Monitor"
echo "============================================================"
echo "Hostname: ${HOSTNAME}"
echo "Project: ${PROJECT}, Zone: ${ZONE}, Environment: ${ENVIRONMENT}"
echo "Timestamp: $(date)"
echo "------------------------------------------------------------"
echo "InfluxDB Primary: ${INFLUXDB_PRI_HOST}:${INFLUXDB_PRI_PORT}/${INFLUXDB_PRI_DATABASE}"
echo "InfluxDB Secondary: ${INFLUXDB_SEC_HOST}:${INFLUXDB_SEC_PORT}/${INFLUXDB_SEC_DATABASE}"
echo "============================================================"

# Get replica status from MySQL
mysql -u"${MYSQL_USER}" -p"${MYSQL_PASSWORD}" -h"${MYSQL_HOST}" -P"${MYSQL_PORT}" -e "SHOW REPLICA STATUS\G" 2>/dev/null > "$TEMP_FILE"

# Check if MySQL command was successful
if [ $? -ne 0 ]; then
    echo "ERROR: Failed to connect to MySQL or retrieve replica status"
    echo "MySQL Host: ${MYSQL_HOST}:${MYSQL_PORT}, User: ${MYSQL_USER}"
    rm -f "$TEMP_FILE"
    exit 1
fi

# Check if there's any replica configuration
if [ ! -s "$TEMP_FILE" ]; then
    echo "WARNING: No replica status found. Server may not be configured as a replica."
    rm -f "$TEMP_FILE"
    exit 0
fi

echo ""
echo "Processing replication channels..."
echo "------------------------------------------------------------"

# Parse the output - process each replica status block
awk '
BEGIN {
    RS = "\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*"
    channel = ""
    source_host = ""
    source_port = ""
    io_running = ""
    sql_running = ""
    seconds_behind = ""
    last_io_errno = ""
    last_sql_errno = ""
    source_log_file = ""
    read_pos = ""
    exec_pos = ""
    relay_space = ""
}
{
    for (i = 1; i <= NF; i++) {
        if ($i ~ /Channel_Name:/) {
            channel = $(i+1)
        }
        else if ($i ~ /Source_Host:/) {
            source_host = $(i+1)
        }
        else if ($i ~ /Source_Port:/) {
            source_port = $(i+1)
        }
        else if ($i ~ /Replica_IO_Running:/) {
            io_running = ($(i+1) == "Yes") ? 1 : 0
        }
        else if ($i ~ /Replica_SQL_Running:/) {
            sql_running = ($(i+1) == "Yes") ? 1 : 0
        }
        else if ($i ~ /Seconds_Behind_Source:/) {
            val = $(i+1)
            seconds_behind = (val == "NULL" || val == "") ? 0 : val
        }
        else if ($i ~ /Last_IO_Errno:/) {
            last_io_errno = $(i+1)
        }
        else if ($i ~ /Last_SQL_Errno:/) {
            last_sql_errno = $(i+1)
        }
        else if ($i ~ /Source_Log_File:/) {
            source_log_file = $(i+1)
        }
        else if ($i ~ /Read_Source_Log_Pos:/) {
            read_pos = $(i+1)
        }
        else if ($i ~ /Exec_Source_Log_Pos:/) {
            exec_pos = $(i+1)
        }
        else if ($i ~ /Relay_Log_Space:/) {
            relay_space = $(i+1)
        }
    }

    # If we have a complete record, print it
    if (channel != "" && source_host != "") {
        print channel "|" source_host "|" source_port "|" io_running "|" sql_running "|" seconds_behind "|" last_io_errno "|" last_sql_errno "|" source_log_file "|" read_pos "|" exec_pos "|" relay_space
    }
}
' "$TEMP_FILE" | while IFS='|' read -r channel source_host source_port io_running sql_running seconds_behind last_io_errno last_sql_errno source_log_file read_pos exec_pos relay_space; do

    # Skip empty lines
    if [ -z "$channel" ]; then
        continue
    fi

    # Send data to InfluxDB
    send_channel_data "$channel" "$source_host" "$source_port" "$io_running" "$sql_running" "$seconds_behind" "$last_io_errno" "$last_sql_errno" "$source_log_file" "$read_pos" "$exec_pos" "$relay_space"
    echo ""
done

# Cleanup
rm -f "$TEMP_FILE"

echo "============================================================"
echo "MySQL Replication Status push completed successfully."
echo "============================================================"
exit 0
