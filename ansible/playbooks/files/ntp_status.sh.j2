#!/bin/bash

HOSTNAME=$(hostname | tr '[:lower:]' '[:upper:]')

# Defaults
enabled=0
synced=0

# Capture timedatectl output once
td_out="$(timedatectl status 2>/dev/null)"

# Detect NTP enabled (works across versions)
if echo "$td_out" | grep -Eq 'NTP enabled:\s*yes|NTP service:\s*active'; then
  enabled=1
fi

# Detect clock synchronization (handles both formats)
if echo "$td_out" | grep -Eq 'NTP synchronized:\s*yes|System clock synchronized:\s*yes'; then
  synced=1
fi

# Output InfluxDB line protocol
echo "ntp_sync_status,host=${HOSTNAME} NTP_enabled=${enabled},NTP_synchronized=${synced}"
