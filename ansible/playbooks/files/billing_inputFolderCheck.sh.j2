#!/bin/bash

##############################################################################
# Script: billing_inputFolderCheck.sh
# Description: billing folder  monitoring with InfluxDB integration
# Usage: with Telegraf
# Generated by Ansible for {{ inventory_hostname }}
# Develop: K. Selvam Enoch (777)
##############################################################################

# Configuration
THRESHOLD=1800  # 30 minutes
NOW=$(date +%s)

# Define directories and tags
paths=(
  "/opt/Roamware/logs/csvprocessor/AMX_SMS/input SMSinput"
  "/opt/Roamware/logs/csvprocessor/AMX_VOICE/input VOICEinput"
  "/opt/Roamware/logs/csvprocessor/AMX_DATA/archive DATAinput"
  "/opt/Roamware/binaries/BillingEngine/data/CDR/SimpleCdr DATAsimplecdr"
)

# Process each path
for entry in "${paths[@]}"; do
  DIR=$(echo "$entry" | awk '{print $1}')
  TAG=$(echo "$entry" | awk '{print $2}')

  if [ -d "$DIR" ]; then
    COUNT=$(find "$DIR" -type f | wc -l)

    if [ "$COUNT" -eq 0 ]; then
      echo "file_age,folder=$TAG oldest_file_age_seconds=0"
    else
      FILE_INFO=$(find "$DIR" -type f -printf "%T@ %p\n" | sort | head -n 1)
      MOD_TIME_FLOAT=$(echo "$FILE_INFO" | cut -d' ' -f1)
      MOD_TIME=${MOD_TIME_FLOAT%.*}  # Truncate decimal (bash-friendly)
      FILENAME=$(echo "$FILE_INFO" | cut -d' ' -f2- | xargs basename)

      AGE=$((NOW - MOD_TIME))

      if [ "$AGE" -ge "$THRESHOLD" ]; then
        echo "file_age,folder=$TAG,filename=$FILENAME oldest_file_age_seconds=$AGE"
      else
        echo "file_age,folder=$TAG oldest_file_age_seconds=$AGE"
      fi
    fi
  else
    echo "file_age,folder=$TAG oldest_file_age_seconds=0"
  fi
done

