##############################################################################
# Script: Telegraf billing Status
# Description: billing monitoring with InfluxDB integration
# Usage: with Telegraf
# Generated by Ansible for {{ inventory_hostname }}
# Develop: K. Selvam Enoch (777)
##############################################################################

[global_tags]
  project = "{{ project }}"
  zone = "{{ zone }}"
  nodeIP = "{{ ansible_host }}"
  service = "billing"

[agent]
  debug = true
  quiet = false
  interval = "30s"
  flush_interval = "30s"
  logfile = "{{ telegraf_remote_path }}/telegraf/logs/{{ telegraf_name }}_telegraf.log"
  hostname = "{{ inventory_hostname }}"
  omit_hostname = false
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 20000
  collection_jitter = "0s"
  flush_jitter = "0s"
  precision = "0s"
  logfile_rotation_interval = "12h"
  logfile_rotation_max_size = "100MB"
  logfile_rotation_max_archives = 5

####### Port Status for {{ inventory_hostname }} #######
{% for item in ports %}
[[inputs.net_response]]
  protocol = "tcp"
  address = "{{ item.ip }}:{{ item.port }}"
  name_override = "portResponsetime"
  tags = { linkName="{{ item.name }}", ip="{{ item.ip }}", port="{{ item.port }}", host="{{ inventory_hostname }}" }
{% endfor %}

######### input folder check ########
[[inputs.exec]]
  commands = ["{{ telegraf_remote_path }}/scripts/billing_inputFolderCheck.sh"]
  timeout = "10s"
  data_format = "influx"
  name_override = "inputFolders"

############# Port Listen #############
[[inputs.exec]]
  commands = ["{{ telegraf_remote_path }}/scripts/{{ telegraf_name }}_port_listen_monitor.sh"]
  timeout = "10s"
  data_format = "influx"
  name_override = "port_listen"

############# Link Monitor #############
[[inputs.exec]]
  commands = ["{{ telegraf_remote_path }}/scripts/{{ telegraf_name }}_port_conn_monitor.sh"]
  timeout = "10s"
  data_format = "influx"
  name_override = "link_count"

############## Ping Monitoring ################
[[inputs.ping]]
  {% set unique_ips = ports | map(attribute='ip') | unique %}
  urls = [{% for ip in unique_ips %}"{{ ip }}"{% if not loop.last %}, {% endif %}{% endfor %}]
  count = 2
  ping_interval = 3.0
  timeout = 2.0
  method = "exec"

##### App Metrics ###########
[[inputs.exec]]
  commands = ["{{ telegraf_remote_path }}/scripts/{{ telegraf_name }}_app_metrics.sh"]
  data_format = "influx"
  name_override = "app_metrics"
  interval = "1m"
  timeout = "50s"

######## Tails ########
[[inputs.tail]]
  files = ["/opt/Roamware/logs/BillingEngine/logs/builder.log"]
  name_override = "Billing_builderLog"
  initial_read_offset = "end"
  data_format = "grok"

  grok_patterns = [
    '''%{CUSTOM_TIMESTAMP:timestamp} %{LOGLEVEL:log_level} \[%{DATA:class}:%{INT:line}\] - %{GREEDYDATA:message}'''
  ]

  grok_custom_patterns = '''
CUSTOM_TIMESTAMP %{YEAR}-%{MONTHNUM}-%{MONTHDAY} %{HOUR}:%{MINUTE}:%{SECOND},%{INT}
'''

[[processors.converter]]
  namepass = ["Billing_builderLog"]
  [processors.converter.fields]
    tag = ["class", "log_level"]

[[inputs.tail]]
  files = ["/opt/Roamware/logs/BillingEngine/logs/invoice-processor.log"]
  name_override = "Billing_invoiceLog"
  initial_read_offset = "end"
  data_format = "grok"

  grok_patterns = [
    '''%{CUSTOM_TIMESTAMP:timestamp} \[%{DATA:thread}\] %{LOGLEVEL:log_level} \[%{DATA:class}:%{INT:line}\] - %{GREEDYDATA:message}'''
  ]

  grok_custom_patterns = '''
CUSTOM_TIMESTAMP %{YEAR}-%{MONTHNUM}-%{MONTHDAY} %{HOUR}:%{MINUTE}:%{SECOND},%{INT}
'''

[[processors.converter]]
  namepass = ["Billing_invoiceLog"]
  [processors.converter.fields]
    tag = ["class", "log_level", "thread"]

[[inputs.tail]]
  files = ["/opt/Roamware/logs/BillingEngine/logs/usage-loader.log"]
  name_override = "Billing_usageLog"
  initial_read_offset = "end"
  data_format = "grok"

  grok_patterns = [
    '''%{CUSTOM_TIMESTAMP:timestamp} \[%{DATA:thread}\] %{LOGLEVEL:log_level} \[%{DATA:class}:%{INT:line}\] - %{GREEDYDATA:message}'''
  ]

  grok_custom_patterns = '''
CUSTOM_TIMESTAMP %{YEAR}-%{MONTHNUM}-%{MONTHDAY} %{HOUR}:%{MINUTE}:%{SECOND},%{INT}
'''

[[processors.converter]]
  namepass = ["Billing_usageLog"]
  [processors.converter.fields]
    tag = ["class", "log_level", "thread"]

[[inputs.tail]]
  files = ["/opt/Roamware/logs/BillingEngine/logs/builder-json.log"]
  name_override = "Billing_builderJsonLog"
  initial_read_offset = "end"
  data_format = "json"
  json_time_key = "ts"
  json_time_format = "2006-01-02 15:04:05.000"
  json_strict = false  # Allows processing even if not all fields match

[[processors.starlark]]
  namepass = ["Billing_builderJsonLog"]
  source = '''
def apply(metric):
    # Flatten nested msg.* fields into top-level
    if "msg.name" in metric.fields:
        metric.fields["msg_name"] = metric.fields["msg.name"]
    return metric
  '''

[[processors.converter]]
  namepass = ["Billing_builderJsonLog"]
  [processors.converter.fields]
    tag = ["msg_name"]


### OUTPUTS Pri #####
[[outputs.influxdb]]
  urls = ["http://{{ influx_Pri_IP }}:{{ influx_Pri_Port }}"]
  database = "{{ influx_priDB_name }}"
  retention_policy = "thirty_days"
  timeout = "5s"
  skip_database_creation = true
  namepass = ["link_count","port_listen","portResponsetime","ping","app_metrics"]

[[outputs.influxdb]]
  urls = ["http://{{ influx_Pri_IP }}:{{ influx_Pri_Port }}"]
  database = "{{ influx_priDB_name }}"
  retention_policy = "1hrRP"
  timeout = "5s"
  namepass = ["Billing_builderLog","Billing_invoiceLog","Billing_usageLog","Billing_builderJsonLog"]

[[outputs.influxdb]]
  urls = ["http://{{ influx_Pri_IP }}:{{ influx_Pri_Port }}"]
  database = "{{ influx_priDB_name }}"
  retention_policy = "one_day"
  timeout = "5s"
  namepass = ["inputFolders"]

### OUTPUTS Sec #####
[[outputs.influxdb]]
  urls = ["http://{{ influx_Sec_IP }}:{{ influx_Sec_Port }}"]
  database = "{{ influx_secDB_name }}"
  retention_policy = "thirty_days"
  timeout = "5s"
  skip_database_creation = true
  namepass = ["link_count","port_listen","portResponsetime","ping","app_metrics"]

[[outputs.influxdb]]
  urls = ["http://{{ influx_Sec_IP }}:{{ influx_Sec_Port }}"]
  database = "{{ influx_secDB_name }}"
  retention_policy = "1hrRP"
  timeout = "5s"
  namepass = ["Billing_builderLog","Billing_invoiceLog","Billing_usageLog","Billing_builderJsonLog"]

[[outputs.influxdb]]
  urls = ["http://{{ influx_Sec_IP }}:{{ influx_Sec_Port }}"]
  database = "{{ influx_secDB_name }}"
  retention_policy = "one_day"
  timeout = "5s"
  namepass = ["inputFolders"]
