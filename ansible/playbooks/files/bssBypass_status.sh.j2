#!/bin/bash
##############################################################################
# Script: bssbypass_status.sh
# Description: BSS byPass monitoring with InfluxDB integration
# Usage: ./bssbypass_status.sh (or) via Telegraf
# Generated by Ansible for {{ inventory_hostname }}
# Develop: K. Selvam Enoch (777)
##############################################################################

# --- Environment Setup ---
export ORACLE_HOME={{ oracle_home | default('/u01/app/oracle/product/11.2.4/client_1') }}
export PATH=$PATH:$ORACLE_HOME/bin

host=$(hostname | tr '[:lower:]' '[:upper:]')
SourceIP=$(hostname -I | awk '{print $2}')

# --- Run Oracle SQL to get current BSS status ---
read CURRENT_ACTIVE_BSS STATUS <<< $(echo -e "
set heading off
set feedback off
set pagesize 0
set linesize 500
SELECT DISTINCT
  CASE WHEN p.ogp_bss_check = 1 THEN m.OBUM_BSS_URL ELSE m.OBUM_BSS_URL_STANDBY END AS CURRENT_ACTIVE_BSS,
  CASE WHEN p.ogp_bss_check = 1 THEN 'ONLOAD' ELSE 'BYPASSED' END AS STATUS
FROM OCS_BSS_URL_MAPPING m, ocs_gx_parameter p
WHERE m.OBUM_REC_STATUS = 1 AND ROWNUM = 1;
exit" | sqlplus -s {{ db_user | default('RWUSER') }}/{{ db_pass | default('ROAMWARE') }}@{{ db_conn | default('RWDB') }} | awk 'NF>0')

# --- Cleanup output ---
CURRENT_ACTIVE_BSS=$(echo "$CURRENT_ACTIVE_BSS" | xargs)
STATUS=$(echo "$STATUS" | xargs)

# --- Derive numeric value for InfluxDB ---
if [[ "$STATUS" == "ONLOAD" ]]; then
  VALUE=1
else
  VALUE=0
fi

# --- Output in InfluxDB line protocol ---
echo "BSS_Status,project={{ project }},host=$host,lclIP=$SourceIP CurrentActiveBSS=\"$CURRENT_ACTIVE_BSS\",status=\"$STATUS\",value=$VALUE"
