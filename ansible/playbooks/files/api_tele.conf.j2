##############################################################################
# Script: Telegraf API Status
# Description: API monitoring with InfluxDB integration
# Usage: with Telegraf
# Generated by Ansible for {{ inventory_hostname }}
# Develop: K. Selvam Enoch (777)
##############################################################################

[global_tags]
  project = "{{ project }}"
  zone = "{{ zone }}"
  node_IP = "{{ ansible_host }}"
  service = "api"

[agent]
  debug = true
  quiet = false
  interval = "30s"
  flush_interval = "30s"
  logfile = "{{ telegraf_remote_path }}/telegraf/logs/{{ telegraf_name }}_telegraf.log"
  hostname = "{{ inventory_hostname }}"
  omit_hostname = false
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 20000
  collection_jitter = "0s"
  flush_jitter = "0s"
  precision = "0s"
  logfile_rotation_interval = "12h"
  logfile_rotation_max_size = "100MB"
  logfile_rotation_max_archives = 5

####### Port Status for {{ inventory_hostname }} #######
{% for item in ports %}
[[inputs.net_response]]
  protocol = "tcp"
  address = "{{ item.ip }}:{{ item.port }}"
  name_override = "portResponsetime"
  tags = { linkName="{{ item.name }}", ip="{{ item.ip }}", port="{{ item.port }}", host="{{ inventory_hostname }}" }
{% endfor %}

############# Port Listen #############
[[inputs.exec]]
  commands = ["{{ telegraf_remote_path }}/scripts/{{ telegraf_name }}_port_listen_monitor.sh"]
  timeout = "10s"
  data_format = "influx"
  name_override = "port_listen"

############# Link Monitor #############
[[inputs.exec]]
  commands = ["{{ telegraf_remote_path }}/scripts/{{ telegraf_name }}_port_conn_monitor.sh"]
  timeout = "10s"
  data_format = "influx"
  name_override = "link_count"

############## Ping Monitoring ################
[[inputs.ping]]
  {% set unique_ips = ports | map(attribute='ip') | unique %}
  urls = [{% for ip in unique_ips %}"{{ ip }}"{% if not loop.last %}, {% endif %}{% endfor %}]
  count = 2
  ping_interval = 3.0
  timeout = 2.0
  method = "exec"

##### App Metrics ###########
[[inputs.exec]]
  commands = ["{{ telegraf_remote_path }}/scripts/{{ telegraf_name }}_app_metrics.sh"]
  data_format = "influx"
  name_override = "app_metrics"
  interval = "1m"
  timeout = "50s"

[[inputs.http_response]]
  ## List of urls to monitor
  urls = [
    "https://cc.amx.claroconnect.com/",
    "https://cc.amx.claroconnect.com/ManageDevices",
    "https://cc.amx.claroconnect.com/LostSims",
    "https://cc.amx.claroconnect.com/Dashboard",
    "https://cc.amx.claroconnect.com/CustomerDashboard",
    "https://cc.amx.claroconnect.com/SimInventory",
    "https://cc.amx.claroconnect.com/SimPartAndPrice",
    "https://cc.amx.claroconnect.com/RetailPlans",
    "https://cc.amx.claroconnect.com/WholeSale",
    "https://cc.amx.claroconnect.com/PriceModel",
    "https://cc.amx.claroconnect.com/DataPlan",
    "https://cc.amx.claroconnect.com/DevicePlan",
    "https://cc.amx.claroconnect.com/ZoneManagement",
    "https://cc.amx.claroconnect.com/ServicePlan",
    "https://cc.amx.claroconnect.com/ManageAPN",
    "https://cc.amx.claroconnect.com/SessionReport",
    "https://cc.amx.claroconnect.com/DataSessionsReport",
    "https://cc.amx.claroconnect.com/DataUsageReport",
    "https://cc.amx.claroconnect.com/DataUsageUplinkReport",
    "https://cc.amx.claroconnect.com/DataUsageDownlinkReport",
    "https://cc.amx.claroconnect.com/DataUsageNetworkTypeReport",
    "https://cc.amx.claroconnect.com/DataUsageSMSReport",
    "https://cc.amx.claroconnect.com/SmsUsageNewReport",
    "https://cc.amx.claroconnect.com/VoiceDetails",
    "https://cc.amx.claroconnect.com/VoiceUsageReport",
    "https://cc.amx.claroconnect.com/SIMActivationsReport",
    "https://cc.amx.claroconnect.com/PreInvoice",
    "https://cc.amx.claroconnect.com/TotalInvoicing",
    "https://cc.amx.claroconnect.com/GeneralPreInvoice",
    "https://cc.amx.claroconnect.com/ManageUser",
    "https://cc.amx.claroconnect.com/ManageApiUser",
    "https://cc.amx.claroconnect.com/ManageAccount",
    "https://cc.amx.claroconnect.com/ManageRole",
    "https://cc.amx.claroconnect.com/GroupHierarchy",
    "https://cc.amx.claroconnect.com/UploadLogo",
    "https://cc.amx.claroconnect.com/BulkIMEIWhitelisting",
    "https://cc.amx.claroconnect.com/SIMProductType",
    "https://cc.amx.claroconnect.com/ManageAudit",
    "https://cc.amx.claroconnect.com/APITransactionLog",
    "https://cc.amx.claroconnect.com/ManageRuleAuditLog",
    "https://cc.amx.claroconnect.com/BatchJobLog",
    "https://cc.amx.claroconnect.com/RuleEngine",
    "https://cc.amx.claroconnect.com/ActiveAlerts",
    "https://cc.amx.claroconnect.com/AlertsHistory",
    "https://cc.amx.claroconnect.com/APILive",
    "https://cc.amx.claroconnect.com/LiveOrder",
    "https://cc.amx.claroconnect.com/ManageOrder",
    "https://cc.amx.claroconnect.com/OrderHistory",
    "https://cc.amx.claroconnect.com/DownloadCenter",
    "https://cc.amx.claroconnect.com/Metabasereports"
  ]
  insecure_skip_verify = true  # Disable SSL verification if necessary
  # Customize other options as needed, e.g., timeout, response codes, etc.
  method = "GET"

[[inputs.prometheus]]
  urls = ["http://localhost:12345/metrics"]
  name_override = "tomcat_metrics"
  interval = "1m"
  timeout = "50s"  
  metric_version = 2  # Version 2 is preferred for Prometheus-style naming

[[inputs.tail]]
  files = ["/opt/airlinq/apache-tomcat-*/logs/catalina.out"]
  initial_read_offset = "beginning"
  name_override = "API_catalina_logs"
  tags = { app = "api" }
  data_format = "grok"
  grok_patterns = ["%{CATALINA_LOG_LINE}"]
  grok_custom_patterns = '''
  CATALINA_LOG_LINE %{TIMESTAMP_ISO8601:log_time}\s+(\[%{DATA:thread}\]|%{DATA:thread})\s+%{LOGLEVEL:log_level}\s+%{DATA:class}\s+-\s+%{GREEDYDATA:message}
'''

[[processors.converter]]
  namepass = ["API_catalina_logs"]
  [processors.converter.fields]
    tag = ["class","log_level"]

############################# END ##################################################

############## OUTPUTS Pri ##############
[[outputs.influxdb]]
  urls = ["http://{{ influx_Pri_IP }}:{{ influx_Pri_Port }}"]
  database = "{{ influx_priDB_name }}"
  retention_policy = "thirty_days"
  timeout = "50s"
  skip_database_creation = true
  namepass = [
    "tomcat_metrics",
    "link_count",
    "port_listen",
    "portResponsetime",
    "ping",
    "app_metrics"
  ]

[[outputs.influxdb]]
  urls = ["http://{{ influx_Pri_IP }}:{{ influx_Pri_Port }}"]
  database = "{{ influx_priDB_name }}"
  retention_policy = "1hrRP"
  timeout = "10s"
  skip_database_creation = true
  namepass = ["http_response", "API_catalina_logs"]

############## OUTPUTS Sec ##############
[[outputs.influxdb]]
  urls = ["http://{{ influx_Sec_IP }}:{{ influx_Sec_Port }}"]
  database = "{{ influx_secDB_name }}"
  retention_policy = "thirty_days"
  timeout = "50s"
  skip_database_creation = true
  namepass = [
    "tomcat_metrics",
    "link_count",
    "port_listen",
    "portResponsetime",
    "ping",
    "app_metrics"
  ]

[[outputs.influxdb]]
  urls = ["http://{{ influx_Sec_IP }}:{{ influx_Sec_Port }}"]
  database = "{{ influx_secDB_name }}"
  retention_policy = "1hrRP"
  timeout = "10s"
  skip_database_creation = true
  namepass = ["http_response", "API_catalina_logs"]
