#!/bin/bash
##############################################################################
# Monitor connection states (established, time_wait, etc.) for given IPs (local or remote)
# Description: Port monitoring with InfluxDB integration
# Usage: via Telegraf
# Generated for Ansible for {{ inventory_hostname }}
# Developed by: K. Selvam Enoch (777)
##############################################################################


SS=/usr/sbin/ss
AWK=/usr/bin/awk

# Capture established/etc sockets (TCP + SCTP)
ss_conn_tcp=$($SS -H -tan)
ss_conn_sctp=$($SS -H -tan -A sctp)

{% for idx in range(ports | length) %}
PORT={{ ports[idx].port }}
NAME="{{ ports[idx].name | default('unknown') }}"
IP="{{ ports[idx].ip | default('*') }}"

read estab time_wait close_wait syn_recv fin_wait1 fin_wait2 last_ack <<< $(
    { echo "$ss_conn_tcp"; echo "$ss_conn_sctp"; } | \
    $AWK -v ip=$IP -v port=$PORT '
    {
        local=$4; remote=$5
        gsub(/\[|\]/,"",local); gsub(/\[|\]/,"",remote)
        gsub(/^::ffff:/,"",local); gsub(/^::ffff:/,"",remote)

        split(local, l, ":"); split(remote, r, ":")
        local_ipport = l[1]":"l[length(l)]
        remote_ipport = r[1]":"r[length(r)]

        if (local_ipport == ip":"port || remote_ipport == ip":"port) {
            state=toupper($1)
            count[state]++
        }
    }
    END {
        print (count["ESTAB"]+0),
              (count["TIME-WAIT"]+0),
              (count["CLOSE-WAIT"]+0),
              (count["SYN-RECV"]+0),
              (count["FIN-WAIT-1"]+0),
              (count["FIN-WAIT-2"]+0),
              (count["LAST-ACK"]+0)
    }')

echo "port_monitor,project={{ project }},zone={{ zone }},host={{ inventory_hostname }},direction=remote,name=$NAME,ip=$IP,port=$PORT estab=$estab,time_wait=$time_wait,close_wait=$close_wait,syn_recv=$syn_recv,fin_wait1=$fin_wait1,fin_wait2=$fin_wait2,last_ack=$last_ack"

{% endfor %}

