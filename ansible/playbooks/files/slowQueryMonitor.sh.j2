#!/bin/bash

##############################################################################
# Script: SlowQueryMonitor.sh
# Description: slowQuery monitoring with InfluxDB integration
# Usage: ./slowQueryMonitor.sh (or) via telegraf auto integration.
# Generated by Ansible for {{ inventory_hostname }}
# Develop: K. Selvam Enoch (777)
##############################################################################

project="{{ project }}"
zone="{{ zone }}"

# MySQL credentials (from host_vars â†’ mysql_servers[0])
MYSQL_USER="{{ mysql_servers[0].user }}"
MYSQL_PASSWORD="{{ mysql_servers[0].password }}"
MYSQL_HOST="localhost"
# some internal ip dont have db access## MYSQL_HOST="{{ hostvars[groups['mysql'][0]]['ansible_host'] }}"
MYSQL_PORT="{{ mysql_servers[0].port }}"

# Query excluding 'Sleep' and 'Connect' commands
QUERY="SELECT id, user, command, time, state, info FROM information_schema.PROCESSLIST WHERE time > 1000 AND command NOT IN ('Sleep', 'Connect');"

# Get internal IP
get_internal_ip() {
    for ip in $(hostname -I); do
        if [[ $ip =~ ^10\. || $ip =~ ^192\.168\. || $ip =~ ^172\.(1[6-9]|2[0-9]|3[0-1])\. ]]; then
            echo "$ip"
            return
        fi
    done
}

source_ip=$(get_internal_ip)
hostname=$(hostname | tr '[:lower:]' '[:upper:]')  # Capitalize the hostname

# Run query and process output
mysql -u"$MYSQL_USER" -p"$MYSQL_PASSWORD" -h"$MYSQL_HOST" -P"$MYSQL_PORT" -e "$QUERY" -s -N 2>/dev/null | \
while IFS=$'\t' read -r id user command time state info; do
    # Replace 'NULL' or empty with 0
    user=${user:-0}; command=${command:-0}; time=${time:-0}; state=${state:-0}; info=${info:-0}
    user=$(echo "$user" | sed 's/^NULL$/0/')
    command=$(echo "$command" | sed 's/^NULL$/0/')
    time=$(echo "$time" | sed 's/^NULL$/0/')
    state=$(echo "$state" | sed 's/^NULL$/0/')
    info=$(echo "$info" | sed 's/^NULL$/0/')

    # Replace spaces with underscores
    user=${user// /_}
    command=${command// /_}
    state=${state// /_}
    info=${info// /_}

    # Sanitize info
    info=$(echo "$info" | tr '\n\r' ' ' | sed 's/"/\\"/g; s/\\/\\\\/g; s/^\s*//; s/\s*$//')

    # Output in InfluxDB format (no host/db)
    echo "mysql_long_running_queries,project=$project,zone=$zone,instance=$source_ip,host=$hostname,user=$user,command=$command,state=$state query_time=$time,id=$id $(date +%s%N)"
done

