---
- name: Provision Grafana Alert Rule Groups with Placeholders
  hosts: grafana
  become: yes
  gather_facts: no
  vars:
    rulegroups:
      - infra_1m
      - infra_5m
      - app_1m
      - app_5m
      - app_30m
      - app_1h
      - mysql_1m
      - mysql_5m
      - mysql_30m
      - mysql_1h
      - sms_1m
      - sms_5m
      - sms_30m
      - oracle_1m
      - oracle_5m
      - oracle_4h
      - nginx_1m
      - redis_1m
      - profileSwitch_1d

  tasks:
    - name: Ensure project provisioning directory exists
      file:
        path: "/etc/grafana/provisioning/alerting"
        state: directory
        owner: aqadmin
        group: aqadmin
        mode: '0755'

    - name: Create placeholder YAML for each rule group
      copy:
        dest: "/etc/grafana/provisioning/alerting/{{ project }}_{{ item }}.yml"
        owner: aqadmin
        group: aqadmin
        mode: "0644"
        content: |
          apiVersion: 1
          groups:
            - orgId: {{ grafana_org_id }}
              name: "{{ item }}"
              folder: "Alerts"
              interval: "{% if item.endswith('1m') %}1m{% elif item.endswith('5m') %}5m{% elif item.endswith('30m') %}30m{% elif item.endswith('1h') %}1h{% elif item.endswith('1d') %}1d{% else %}5m{% endif %}"
              rules:
                - uid: "{{ item }}_placeholder"
                  title: "{{ item }} placeholder rule"
                  condition: "C"
                  data:
                    - refId: "A"
                      queryType: "instant"
                      relativeTimeRange:
                        from: 0
                        to: 0
                      datasourceUid: "__expr__"
                      model:
                        datasource:
                          type: "__expr__"
                          uid: "__expr__"
                        editorMode: "code"
                        expr: "1"
                        refId: "A"
                        resultFormat: "time_series"
                  for: "0s"
                  labels: {}
                  noDataState: "OK"
                  execErrState: "OK"
                  isPaused: false
      loop: "{{ rulegroups }}"

    - name: Restart Grafana service to apply rule groups provisioning
      service:
        name: grafana-server
        state: restarted
      become: yes
